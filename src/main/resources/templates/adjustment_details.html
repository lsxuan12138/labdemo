<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="Responsive Admin Dashboard Template" name="description">
    <meta content="admin,dashboard" name="keywords">
    <meta content="stacks" name="author">
    <!-- The above 6 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- Title -->
    <title>Space - Responsive Admin Dashboard Template</title>

    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
    <link href="../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="../static/icomoon/style.css" rel="stylesheet">
    <link href="../static/uniform/css/default.css" rel="stylesheet"/>
    <link href="../static/switchery/switchery.min.css" rel="stylesheet"/>
    <link href="../static/datatables/css/jquery.datatables.min.css" rel="stylesheet" type="text/css"/>
    <link href="../static/datatables/css/jquery.datatables_themeroller.css" rel="stylesheet" type="text/css"/>
    <link href="../static/bootstrap-datepicker/css/datepicker3.css" rel="stylesheet" type="text/css"/>
    <!-- Theme Styles -->
    <link href="../static/space.min.css" rel="stylesheet">
    <link href="../static/themes/admin2.css" rel="stylesheet">
    <link href="../static/custom.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

<!-- 左侧菜单栏 -->
<div class="page-container">
    <!-- Page Sidebar -->
    <div class="page-sidebar">
        <a class="logo-box" th:href="@{/}">
            <span>通用销售系统v3.0</span>
        </a>
        <div class="page-sidebar-inner">
            <div class="page-sidebar-menu">
                <ul class="accordion-menu">
                    <li>
                        <a th:href="@{/}">
                            <i class="menu-icon icon-home4"></i><span>首页</span>
                        </a>
                    </li>
                    <li class="active-page">
                        <a href="javascript:void(0);">
                            <i class="menu-icon icon-flash_on"></i><span>库存</span><i
                                class="accordion-icon fa fa-angle-left"></i>
                        </a>
                        <ul class="sub-menu">
                            <li><a th:href="@{/product/store}">全部库存</a></li>
                            <li><a th:href="@{/product/storeHouse}">仓库库存统计</a></li>
                            <li><a th:href="@{/product/purchase}">进货</a></li>
                            <li><a th:href="@{/product/adjust}">调货</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="javascript:void(0);">
                            <i class="menu-icon icon-layers"></i><span>客户</span><i
                                class="accordion-icon fa fa-angle-left"></i>
                        </a>
                        <ul class="sub-menu">
                            <li><a th:href="@{/client/all}">全部客户</a></li>
                            <li><a th:href="@{/client/wholesales}">批发客户</a></li>
                            <li><a th:href="@{/client/retails}">零售客户</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="javascript:void(0);">
                            <i class="menu-icon icon-code"></i><span>销售</span><i
                                class="accordion-icon fa fa-angle-left"></i>
                        </a>
                        <ul class="sub-menu">
                            <li><a th:href="@{/saleNote/all}">销售单</a></li>
                            <li><a th:href="@{/saleNote/product}">货品销售统计</a></li>
                            <li><a th:href="@{/saleNote/client}">客户销售统计</a></li>
                            <li><a th:href="@{/saleNote/receive}">客户结款情况</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="javascript:void(0);">
                            <i class="menu-icon icon-format_list_bulleted"></i><span>货品</span><i
                                class="accordion-icon fa fa-angle-left"></i>
                        </a>
                        <ul class="sub-menu">
                            <li><a th:href="@{/product/all}">货品</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="javascript:void(0);">
                            <i class="menu-icon icon-star"></i><span>用户</span><i
                                class="accordion-icon fa fa-angle-left"></i>
                        </a>
                        <ul class="sub-menu">
                            <li><a th:href="@{/user/control}">用户激活</a></li>
                            <li><a th:href="@{/user/sale}">业绩统计</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="javascript:void(0);">
                            <i class="menu-icon icon-show_chart"></i><span>经营状况</span><i
                                class="accordion-icon fa fa-angle-left"></i>
                        </a>
                        <ul class="sub-menu">
                            <li><a th:href="@{/company}">经营状况统计</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div><!-- /左侧菜单栏 -->

    <!-- Page Content -->
    <div class="page-content">
        <!-- Page Header -->
        <div class="page-header">
            <!-- 上方导航栏 -->
            <nav class="navbar navbar-default">
                <div class="container-fluid">
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav">
                            <li><a href="javascript:void(0)" id="collapsed-sidebar-toggle-button"><i
                                    class="fa fa-bars"></i></a></li>
                            <li><a href="javascript:void(0)" id="toggle-fullscreen"><i class="fa fa-expand"></i></a>
                            </li>
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                            <li><a th:href="@{/user/now}">个人中心</a></li>
                            <li><a th:href="@{/user/login}" id="quit">退出登录</a></li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </div><!-- /.container-fluid -->
            </nav>
        </div><!-- /Page Header -->
        <!-- Page Inner -->
        <div class="page-inner">
            <div class="page-title">
                <h3 class="breadcrumb-header">调货单详情
                    <div class="btn-group" style="float: right">
                        <button class="btn btn-info m-b-sm" onclick=audit()  type="button">
                            审核
                        </button>
                        <button class="btn btn-info m-b-sm" onclick=save()  type="button">
                            保存
                        </button>
                        <a class="btn btn-info m-b-sm" th:href="@{/product/adjust}" type="button">返回</a>
                    </div>
                </h3>
                <form class="form-inline mb-2">
                    <p th:text="'调货单编号：'+${adjustmentDetails.id}" style="display: inline"></p>
                    <p th:text="'源仓库：'+${adjustmentDetails.srcStoreHouse}" style="display: inline;position: relative;left: 7%"></p>
                    <p th:text="'目的仓库：'+${adjustmentDetails.destStoreHouse}" style="display: inline;position: relative;left: 14%"></p>
                    <p th:text="'调货单状态：'+${adjustmentDetails.stage}" style="display: inline;position: relative;left: 21%"></p>
                    <div style="float: right">
                        <label for="inputProducts">商品名称：</label>
                        <input autocomplete="off" id="inputProduct" list="inputProducts" size=10
                               style="width:100px">
                        <datalist id="inputProducts" size=10 style="width:100px">
                            <option th:each="product:${productList}" th:value="${product.name}"/>
                        </datalist>
                        <input id="inputQuantity" placeholder="数量" style="width:50px">
                        <button class="btn btn-primary mr-sm-2" onclick=add() type="button">添加</button>
                    </div>
                </form>
            </div>
            <div id="main-wrapper">
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-white">
                            <div class="panel-body">
                                <!-- Modal -->
                                <form action="javascript:void(0);" id="change-row-form">
                                    <div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade"
                                         id="myModal_change"
                                         role="dialog" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button aria-label="Close" class="close" data-dismiss="modal"
                                                            type="button"><span
                                                            aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title" id="myModalLabel_edit">修改</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <p id="changePopId">商品序号：</p>
                                                        <p id="changePopName">商品名称：</p>
                                                        <label>商品数量：</label>
                                                        <input class="form-control" id="changePopQuantity" type="text"/>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="btn btn-default" data-dismiss="modal"
                                                            type="button">取消
                                                    </button>
                                                    <button class="btn btn-success" id="change-row" onclick=change()
                                                            type="submit">确定
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <form action="javascript:void(0);" id="delete-row-form">
                                    <div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade"
                                         id="myModal_delete"
                                         role="dialog" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button aria-label="Close" class="close" data-dismiss="modal"
                                                            type="button"><span
                                                            aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title" id="myModalLabel_delete">删除</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <p>确定删除该商品吗？</p>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="btn btn-default" data-dismiss="modal"
                                                            type="button">取消
                                                    </button>
                                                    <button class="btn btn-success" id="delete-row" onclick=del()
                                                            type="submit">确定
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <form action="javascript:void(0);" id="alert-row-form">
                                    <div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade"
                                         id="myModal_alert"
                                         role="dialog" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <button aria-label="Close" class="close" data-dismiss="modal"
                                                            type="button"><span
                                                            aria-hidden="true">&times;</span></button>
                                                    <h4 class="modal-title" id="myModalLabel_alert">提示</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <p id="alert"></p>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="btn btn-default" data-dismiss="modal"
                                                            type="button">取消
                                                    </button>
                                                    <button class="btn btn-success" id="alert-row"
                                                            type="submit">确定
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div class="table-responsive">
                                    <table class="display table" data-locale="zh-CN" data-toggle="table" id="tb"
                                           style="width: 100%; cellspacing: 0;">
                                        <thead>
                                        <tr>
                                            <th>序号</th>
                                            <th>商品名</th>
                                            <th>商品数量</th>
                                            <th>进货价</th>
                                            <th>批发价</th>
                                            <th>零售价</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="item:${adjustmentDetails.getItems()}">
                                            <td th:text="${item.id}">1</td>
                                            <td th:text="${item.name}">华为手机</td>
                                            <td th:text="${item.quantity}">1</td>
                                            <td th:text="${item.purchasePrice}">5000</td>
                                            <td th:text="${item.wholesalePrice}">5000</td>
                                            <td th:text="${item.retailPrice}">5000</td>
                                            <td>
                                                <div class="btn-group">
                                                <button class="btn btn-info btn-large" style="width:50%" data-target="#myModal_delete"
                                                        data-toggle="modal"
                                                        onclick=delModel(this)
                                                        type="button">
                                                    删除
                                                </button>
                                                <button class="btn btn-info btn-large" style="width:50%" data-target="#myModal_change"
                                                        data-toggle="modal"
                                                        onclick=changeQuantity(this)
                                                        type="button">修改
                                                </button>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- Row -->
            </div><!-- Main Wrapper -->
        </div><!-- /Page Inner -->
    </div><!-- /Page Content -->
</div><!-- /Page Container -->


<!-- Javascripts -->
<script src="../static/jquery/jquery-3.1.0.min.js"></script>
<script src="../static/bootstrap/js/bootstrap.min.js"></script>
<script src="../static/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<script src="../static/uniform/js/jquery.uniform.standalone.js"></script>
<script src="../static/switchery/switchery.min.js"></script>
<script src="../static/datatables/js/jquery.datatables.js"></script>
<script src="../static/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
<script src="../static/space.min.js"></script>
<script th:inline="javascript">
    $('#quit').on('click', function () {
        $.ajax({
            url: "/user/quit",
            type: "POST",  /*采用POST方法提交*/
            dataType: 'JSON',
            contentType: 'application/json;charset=UTF-8',
            cache: false,
            success: function (result) {
                //alert(result)
                if (result.code === "200") {
                    console.log("请求成功")
                    document.cookie = "token=0; max-age=0; path=/";
                    window.location.href="/user/login";
                } else {
                    alert(result.message)
                }
            }
        })
    });
    var table1 = $('#tb').DataTable();
    const productList = [[${productList}]];
    const adjustmentDetails = [[${adjustmentDetails}]]
    let stageT = adjustmentDetails.stage;
    table1.rows().invalidate().draw();
    let tr;
    function alert(message){
        $('.modal').modal('hide');
        $('#myModal_alert').modal("show",);
        $("#alert").html(message);
    }
    $('#alert-row').on('click', function () {
        $('#myModal_alert').modal("hide");
        window.location.reload();
    });
    function delModel(obj){
        tr = obj.parentNode.parentNode //取到了tr对象
    }
    function del() {
        let stage = stageT;
        if (stage !== "待审核" && stage !== "未编辑") {
            alert("已审核，禁止编辑");
            return;
        }
        tr.parentNode.removeChild(tr);
        table1.row(tr).remove().draw();//避免table1和tb不同步的现象
        $('.modal').modal('hide');
    }

    let changeProductId;
    let targetRow;

    function changeQuantity(obj) {
        let stage = stageT;
        let value = $(obj).parent().parent().parent().find("td");
        targetRow = value;
        let id = Number(value.eq(0).text());
        let name = value.eq(1).text();
        let quantity = Number(value.eq(2).text());
        changeProductId = id;
        $("#changePopId").html("商品编号：" + id);
        $("#changePopName").html("商品名称：" + name);
        $("#changePopQuantity").val(quantity);
    }

    function change(obj) {
        let stage = stageT;
        if (stage !== "待审核" && stage !== "未编辑") {
            alert("已审核，禁止编辑");
            return;
        }
        let quantityStr = $("#changePopQuantity").val();
        let quantity = Number(quantityStr)
        if (!Number.isInteger(quantity)) {
            alert("请输入一个整数");
            return;
        }
        if (isNaN(quantity) || quantity < 0) {
            alert("请输入一个正整数");
            return;
        }
        for (const product of productList) {
            if (product.id === changeProductId) {
                if (quantity > product.quantity) {
                    alert("库存只有" + product.quantity + "个");
                    return;
                }
                break;
            }
        }
        targetRow.eq(2).html(quantity);
        $('.modal').modal('hide');
    }

    function add() {
        let stage = stageT;
        if (stage !== "待审核" && stage !== "未编辑") {
            alert("已审核，禁止编辑");
            return;
        }
        let name = $("#inputProduct").val();
        let quantity = Number($("#inputQuantity").val());
        let data = getTableContent("tb");
        if (isNaN(quantity) || quantity < 0) {
            alert("请输入一个正整数");
            return;
        }
        for (let i = 1; i < data.length; i++) {
            if (data[i][1] == name) {
                alert("该商品已在该调货单中");
                return;
            }
        }

        for (const product of productList) {
            if (product.name === name) {
                console.log(product)
                var trObj = document.createElement("tr");
                trObj.id = new Date().getTime();
                let purchasePrice = Number.parseFloat(product.purchasePrice);
                let wholesalePrice = Number.parseFloat(product.wholesalePrice);
                let retailPrice = Number.parseFloat(product.retailPrice);
                trObj.innerHTML =
                    `<td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${quantity}</td>
                    <td>${purchasePrice}</td>
                    <td>${wholesalePrice}</td>
                    <td>${retailPrice}</td>
                    <td>
                    <div class="btn-group">
                         <button class="btn btn-info btn-large" style="width: 50%" data-target="#myModal_delete" data-toggle="modal"
                         onclick=delModel(this) type="button">删除</button>
                         <button class="btn btn-info btn-large" style="width: 50%" data-target="#myModal_change" data-toggle="modal"
                         onclick=changeQuantity(this) type="button">修改</button>
                    </div>
                    </td>`;
                document.getElementById("tb").appendChild(trObj);
                table1.row.add(trObj).draw();
            }
        }
        stageT = "待审核"
    }

    function save() {
        let stage = adjustmentDetails.stage;
        if (stage !== "未编辑" && stage !== "待审核") {
            alert("已审核，保存无效");
            return;
        }
        let data = getTableContent("tb");
        // console.log(data);
        // console.log(detail);
        let str = "{";
        str += "\"id\":" + adjustmentDetails.id + ",";
        str += "\"stage\":\"" + adjustmentDetails.stage + "\",";
        str += "\"items\":" + "[";
        for (let i = 1; i < data.length; i++) {
            if(data[1][0]==="暂无相关数据")break;
            str += "{"
            str += "\"id\":" + data[i][0] + ",";
            str += "\"quantity\":" + data[i][2];
            str += "}";
            if (i !== data.length - 1) str += ",";
        }
        str += "]}";
        //console.log(str)
        $.ajax({
            url: "/product/adjustmentUpdate",
            type: "POST",  /*采用POST方法提交*/
            data: str,
            dataType: 'json',
            contentType: 'application/json;charset=UTF-8',
            cache: false,
            success: function (result) {
                //alert(JSON.stringify(result.data))
                if (result.code === "200") {
                    window.location.reload();
                } else {
                    alert(result.message)
                }
            }

        })
    }

    function audit() {
        let id = adjustmentDetails.id;
        let stage = adjustmentDetails.stage;
        if (stage === "未编辑") {
            alert("请先保存订单");
            return;
        } else if (stage !== "待审核") {
            alert("已审核，禁止再次审核");
            return;
        }
        $.ajax({
            url: "/product/adjustmentAudit",
            type: "POST",  /*采用POST方法提交*/
            data: {"id": id, "stage": "已审核"},
            dataType: 'json',
            cache: false,
            //contentType:'application/json;charset=UTF-8',
            success: function (result) {
                //alert(JSON.stringify(result.data))
                if (result.code === "200") {
                    window.location.reload();
                } else {
                    alert(result.message)
                }
            }

        })
    }
    function getTableContent(id) {
        var mytable = document.getElementById(id);
        var data = [];
        for (var i = 0, rows = mytable.rows.length; i < rows; i++) {
            for (var j = 0, cells = mytable.rows[i].cells.length; j < cells; j++) {
                if (!data[i]) {
                    data[i] = new Array();
                }
                data[i][j] = mytable.rows[i].cells[j].innerHTML;
            }
        }
        return data;
    }
</script>
<script type="text/javascript">
    function putValueToInput() {
        var telUserName = document.getElementById("telUserName");
        var perpage = telUserName.options[telUserName.selectedIndex].text;
        var input = document.getElementById("input");
        input.value = perpage;
    }

    function inputValue() {
        var input = document.getElementById("input").value;
        var telUserName = document.getElementById("telUserName");
        var options = telUserName.getElementsByTagName("option");
        var div = document.getElementById("DIV");
        div.innerHTML = "";
        var a = 0;
        for (var i = options.length - 1; i >= 1; i--) {
            var optionText = options[i].text;
            if (optionText.indexOf(input) >= 0) {
                div.style.display = 'block';
                div.innerHTML += "<span style='font-size: 12px;' onclick='getValue(this)'>" + optionText + "</span><br/>";
                a++;
            }
        }
        if (a == 0) {
            div.style.display = 'none';
        }
    }

    function getValue(obj) {
        var telUserName = document.getElementById("telUserName");
        var options = telUserName.getElementsByTagName("option");
        var div = document.getElementById("DIV");
        for (var i = options.length - 1; i >= 1; i--) {
            var optionText = options[i].text;
            var optionValue = options[i].value;
            if (obj.innerHTML == optionText) {
                telUserName.value = optionValue;
                document.getElementById("input").value = optionText;
                div.style.display = 'none';
                div.innerHTML = "";
            }
        }
    }


</script>
</body>

</html>